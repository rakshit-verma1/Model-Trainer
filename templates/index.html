<!DOCTYPE html>
<html lang="en" class="h-full">

<head>
  {% load static %}
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Neural Trainer — Universal PyTorch Builder</title>
  <meta name="description" content="Design, train, and export any PyTorch model with AI-powered suggestions.">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap"
    rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] },
          colors: {
            surface: { 50: '#ffffff', 100: '#f8fafc', 200: '#f1f5f9', 300: '#e2e8f0', 400: '#cbd5e1' },
            ink: { 50: '#f8fafc', 100: '#94a3b8', 200: '#64748b', 300: '#475569', 400: '#334155', 500: '#1e293b', 600: '#0f172a' },
            primary: { 50: '#eef2ff', 100: '#e0e7ff', 200: '#c7d2fe', 300: '#a5b4fc', 400: '#818cf8', 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca' },
            success: { 400: '#34d399', 500: '#10b981', 600: '#059669' },
            danger: { 400: '#f87171', 500: '#ef4444' },
            warn: { 400: '#fbbf24', 500: '#f59e0b' },
          },
          animation: {
            'slide-up': 'slideUp .22s ease',
            'fade-in': 'fadeIn .3s ease',
          },
          keyframes: {
            slideUp: { from: { opacity: 0, transform: 'translateY(6px)' }, to: { opacity: 1, transform: 'translateY(0)' } },
            fadeIn: { from: { opacity: 0 }, to: { opacity: 1 } },
          },
        },
      },
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>

<body class="h-full bg-surface-100 text-ink-500 font-sans overflow-hidden antialiased">

  <!-- ═══ HEADER ═══ -->
  <header
    class="flex items-center gap-4 h-[50px] px-5 bg-white/80 border-b border-surface-300/60 backdrop-blur-xl sticky top-0 z-50 shrink-0">
    <div class="flex items-center gap-2 shrink-0">
      <svg class="w-5 h-5 text-primary-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
        <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" />
      </svg>
      <span class="font-extrabold text-[1.05rem] text-ink-600 tracking-tight">Neural Trainer</span>
    </div>
    <nav class="flex gap-1 flex-1">
      <button class="pill active" onclick="showPanel('builder',this)">
        <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="7" height="7" rx="1.5" />
          <rect x="14" y="3" width="7" height="7" rx="1.5" />
          <rect x="3" y="14" width="7" height="7" rx="1.5" />
          <rect x="14" y="14" width="7" height="7" rx="1.5" />
        </svg>
        Builder
      </button>
      <button class="pill" onclick="showPanel('train',this)" id="tab-train">
        <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="22 12 18 12 15 21 9 3 6 12 2 12" />
        </svg>
        Training
      </button>
    </nav>
    <div id="device-badge"
      class="text-[.7rem] px-2.5 py-0.5 rounded-full bg-surface-200 text-ink-200 border border-surface-300 shrink-0 font-medium">
      CPU</div>
  </header>

  <!-- ═══ BUILDER PANEL ═══ -->
  <div id="panel-builder" class="panel active">
    <!-- LEFT SIDEBAR -->
    <aside
      class="w-[264px] shrink-0 flex flex-col gap-2 p-2.5 overflow-y-auto border-r border-surface-300/50 bg-surface-50">

      <!-- Config -->
      <div class="card">
        <h3 class="section-title">
          <svg class="w-3.5 h-3.5 text-primary-500" viewBox="0 0 24 24" fill="none" stroke="currentColor"
            stroke-width="2">
            <circle cx="12" cy="12" r="3" />
            <path
              d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z" />
          </svg>
          Configuration
        </h3>
        <label class="field-lbl">Task Type</label>
        <select id="task-type" class="ctrl" onchange="onTaskTypeChange(this.value)">
          <option value="classification">Classification</option>
          <option value="regression">Regression</option>
        </select>
        <label class="field-lbl">Dataset</label>
        <select id="dataset" class="ctrl" onchange="onDatasetChange(this.value)">
          <option value="mnist">MNIST (28×28 grayscale)</option>
          <option value="cifar10">CIFAR-10 (32×32 RGB)</option>
          <option value="custom">Custom Images (ZIP)</option>
          <option value="csv">Tabular Data (CSV)</option>
        </select>
        <div id="custom-ds-area" class="hidden mt-2">
          <div id="drop-zone" class="drop-zone" onclick="document.getElementById('custom-file').click()"
            ondragover="dzDragOver(event)" ondragleave="dzDragLeave(event)" ondrop="dzDrop_file(event)">
            <svg class="w-5 h-5 mx-auto mb-1 text-ink-100" viewBox="0 0 24 24" fill="none" stroke="currentColor"
              stroke-width="1.5">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
              <polyline points="17 8 12 3 7 8" />
              <line x1="12" y1="3" x2="12" y2="15" />
            </svg>
            <span id="drop-label" class="text-[.72rem] text-ink-200">Drop ZIP/CSV or click to upload</span>
            <input type="file" id="custom-file" accept=".zip,.csv" class="hidden" onchange="onFileSelected(this)">
          </div>
        </div>
        <label class="field-lbl">Optimizer</label>
        <select id="optimizer" class="ctrl">
          <option value="adam">Adam</option>
          <option value="sgd">SGD</option>
          <option value="rmsprop">RMSProp</option>
          <option value="adamw">AdamW</option>
          <option value="adagrad">Adagrad</option>
          <option value="adadelta">Adadelta</option>
        </select>
        <label class="field-lbl">Loss</label>
        <select id="loss" class="ctrl">
          <option value="CrossEntropyLoss">Cross Entropy</option>
          <option value="NLLLoss">NLL</option>
          <option value="MSELoss">MSE</option>
          <option value="L1Loss">L1 / MAE</option>
          <option value="HuberLoss">Huber</option>
          <option value="SmoothL1Loss">Smooth L1</option>
          <option value="BCEWithLogitsLoss">BCE Logits</option>
        </select>
        <div class="grid grid-cols-2 gap-2 mt-1">
          <div><label class="field-lbl">LR</label><input type="number" id="lr" class="ctrl" value="0.001" step="0.0001"
              min="0.00001" max="1"></div>
          <div><label class="field-lbl">Epochs</label><input type="number" id="epochs" class="ctrl" value="5" min="1"
              max="200"></div>
        </div>
      </div>

      <!-- Layer Palette -->
      <div class="card">
        <h3 class="section-title">
          <svg class="w-3.5 h-3.5 text-primary-500" viewBox="0 0 24 24" fill="none" stroke="currentColor"
            stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2" />
            <line x1="3" y1="9" x2="21" y2="9" />
            <line x1="3" y1="15" x2="21" y2="15" />
            <line x1="9" y1="3" x2="9" y2="21" />
            <line x1="15" y1="3" x2="15" y2="21" />
          </svg>
          Layer Palette
        </h3>
        <p class="text-[.65rem] text-ink-100 mb-2">Click to add · Drag to reorder</p>
        <div id="palette-container"></div>
      </div>

      <!-- Templates -->
      <div class="card">
        <h3 class="section-title">
          <svg class="w-3.5 h-3.5 text-primary-500" viewBox="0 0 24 24" fill="none" stroke="currentColor"
            stroke-width="2">
            <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" />
          </svg>
          Templates
        </h3>
        <div class="grid gap-1">
          <button class="tmpl-btn" onclick="loadTemplate('mlp')">MLP — MNIST</button>
          <button class="tmpl-btn" onclick="loadTemplate('cnn')">CNN — CIFAR-10</button>
          <button class="tmpl-btn" onclick="loadTemplate('resnet')">ResNet Block (skip)</button>
          <button class="tmpl-btn" onclick="loadTemplate('transformer')">Transformer Clf</button>
          <button class="tmpl-btn" onclick="loadTemplate('regression')">Regression MLP</button>
        </div>
      </div>

      <button
        class="w-full py-2.5 rounded-lg bg-primary-500 text-white font-semibold text-sm shadow-md shadow-primary-500/20 hover:bg-primary-600 hover:-translate-y-px hover:shadow-lg active:translate-y-0 transition-all cursor-pointer"
        id="btn-train" onclick="startTraining()">
        <span class="flex items-center justify-center gap-1.5">
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
            <polygon points="5 3 19 12 5 21 5 3" />
          </svg>
          Start Training
        </span>
      </button>
      <button
        class="w-full py-1.5 rounded-lg border border-danger-400/30 text-danger-500 text-[.76rem] hover:bg-danger-400/5 transition-all cursor-pointer mt-1"
        onclick="clearLayers()">Clear Network</button>
    </aside>

    <!-- CENTER -->
    <main class="flex-1 flex flex-col overflow-hidden bg-surface-100">
      <!-- Toolbar -->
      <div
        class="flex items-center justify-between px-5 h-[42px] border-b border-surface-300/50 bg-white/60 backdrop-blur-md shrink-0">
        <span class="font-semibold text-[.82rem] text-ink-400">Network Architecture</span>
        <div class="flex items-center gap-3">
          <div class="flex bg-surface-200 rounded-lg p-0.5">
            <button id="mode-btn-nodes" class="vmode-btn active" onclick="setViewMode('nodes',this)">
              <svg class="w-3 h-3" viewBox="0 0 24 24" fill="currentColor">
                <circle cx="5" cy="5" r="3" />
                <circle cx="19" cy="5" r="3" />
                <circle cx="5" cy="19" r="3" />
                <circle cx="19" cy="19" r="3" />
                <circle cx="12" cy="12" r="3" />
              </svg>
              Nodes
            </button>
            <button id="mode-btn-arch" class="vmode-btn" onclick="setViewMode('arch',this)">
              <svg class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="2" y="2" width="20" height="6" rx="1" />
                <rect x="2" y="16" width="20" height="6" rx="1" />
                <line x1="12" y1="8" x2="12" y2="16" />
              </svg>
              Architecture
            </button>
          </div>
          <span class="font-mono text-[.7rem] text-success-500 font-medium" id="param-count">— params</span>
        </div>
      </div>

      <!-- Diagram area -->
      <div class="flex-1 overflow-auto flex items-start justify-center p-5 min-h-0" id="diagram-container">
        <div class="flex flex-col items-center gap-3 text-ink-100 text-sm mt-20" id="empty-state">
          <svg class="w-16 h-16 text-primary-300/50" viewBox="0 0 24 24" fill="none" stroke="currentColor"
            stroke-width="1">
            <path
              d="M12 2a4 4 0 0 1 4 4c0 1.5-.8 2.5-2 3.5V12h3a4 4 0 0 1 4 4 4 4 0 0 1-4 4H7a4 4 0 0 1-4-4 4 4 0 0 1 4-4h3V9.5C8.8 8.5 8 7.5 8 6a4 4 0 0 1 4-4z" />
          </svg>
          <p>Add layers from the palette to build your network</p>
        </div>
        <svg id="net-svg" height="280" width="100"></svg>
        <div id="arch-diagram" class="hidden w-full max-w-2xl"></div>
      </div>

      <!-- Gemini -->
      <div class="border-t border-surface-300/50 bg-white/70 backdrop-blur-xl">
        <div class="flex items-center justify-between px-5 py-2 cursor-pointer select-none group"
          onclick="toggleGeminiPanel()">
          <span
            class="font-semibold text-[.82rem] text-transparent bg-clip-text bg-gradient-to-r from-purple-500 via-cyan-500 to-violet-500">
            <svg class="w-4 h-4 inline -mt-0.5 mr-1 text-purple-500" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2L9.19 8.63 2 9.24l5.46 4.73L5.82 21 12 17.27 18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2z" />
            </svg>
            AI Assistant
          </span>
          <span id="gemini-toggle" class="text-ink-100 group-hover:text-ink-300 transition-colors text-sm">▴</span>
        </div>
        <div id="gemini-body" class="px-5 pb-3 max-h-[300px] overflow-y-auto">
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="field-lbl">Describe your task</label>
              <textarea id="gemini-prompt" class="ctrl h-16 resize-y text-[.78rem]"
                placeholder="e.g., ResNet-style classifier for CIFAR-10 with skip connections…"></textarea>
              <button class="gemini-btn mt-1.5" onclick="geminiSuggest()">
                <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="currentColor">
                  <path
                    d="M12 2L9.19 8.63 2 9.24l5.46 4.73L5.82 21 12 17.27 18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2z" />
                </svg>
                Suggest Architecture
              </button>
            </div>
            <div>
              <label class="field-lbl">Upload Paper (PDF)</label>
              <div class="drop-zone h-[52px] flex items-center justify-center" id="pdf-drop"
                onclick="document.getElementById('pdf-file').click()" ondragover="pdfDragOver(event)"
                ondragleave="pdfDragLeave(event)" ondrop="pdfDrop(event)">
                <svg class="w-4 h-4 mr-1.5 text-ink-100" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                  stroke-width="1.5">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                  <polyline points="14 2 14 8 20 8" />
                </svg>
                <span id="pdf-drop-label" class="text-[.72rem] text-ink-200">Drop PDF or click</span>
                <input type="file" id="pdf-file" accept=".pdf" class="hidden" onchange="pdfFileSelected(this)">
              </div>
              <button class="gemini-btn gemini-btn-alt mt-1.5" onclick="geminiParsePdf()">
                <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                  <polyline points="14 2 14 8 20 8" />
                </svg>
                Generate from PDF
              </button>
            </div>
          </div>
          <div id="gemini-output" class="hidden mt-2.5 border border-surface-300 rounded-lg overflow-hidden bg-white">
            <div
              class="flex items-center justify-between px-3 py-1.5 text-[.72rem] font-semibold text-primary-500 bg-primary-50 border-b border-surface-300">
              <span>AI Response</span>
              <button id="gemini-apply-btn"
                class="hidden px-2.5 py-0.5 rounded-md bg-success-500 text-white text-[.68rem] font-semibold hover:bg-success-600 transition-all cursor-pointer"
                onclick="applyGeminiArchitecture()">✓ Apply</button>
            </div>
            <div id="gemini-output-body" class="px-3 py-2.5 text-[.76rem] leading-relaxed text-ink-400"></div>
          </div>
        </div>
      </div>
    </main>

    <!-- RIGHT: Layer List -->
    <aside class="w-[244px] shrink-0 border-l border-surface-300/50 bg-surface-50 flex flex-col overflow-hidden">
      <div class="px-4 pt-3 pb-1.5 flex items-center gap-2">
        <h3 class="text-[.75rem] font-semibold text-ink-300 uppercase tracking-wider">Layers</h3>
        <span id="layer-count"
          class="bg-primary-500 text-white rounded-full px-2 py-px text-[.6rem] font-bold min-w-[18px] text-center">0</span>
      </div>
      <div id="layer-list" class="flex-1 overflow-y-auto px-2 pb-3"></div>
    </aside>
  </div>

  <!-- ═══ TRAINING PANEL ═══ -->
  <div id="panel-train" class="panel">
    <div class="grid grid-cols-2 gap-2.5 p-2.5 w-full h-full"
      style="grid-template-rows:auto 1fr 1fr;grid-template-areas:'status status' 'loss acc' 'net log'">
      <div class="card flex gap-3 flex-wrap px-4 py-2.5" style="grid-area:status">
        <div class="stat-box"><span class="stat-lbl">Epoch</span><span class="stat-val" id="stat-epoch">—</span></div>
        <div class="stat-box"><span class="stat-lbl">Train Loss</span><span class="stat-val" id="stat-loss">—</span>
        </div>
        <div class="stat-box"><span class="stat-lbl">Val Loss</span><span class="stat-val" id="stat-val-loss">—</span>
        </div>
        <div class="stat-box"><span class="stat-lbl" id="stat-metric1-label">Train Acc</span><span
            class="stat-val text-success-500" id="stat-acc">—</span></div>
        <div class="stat-box"><span class="stat-lbl" id="stat-metric2-label">Val Acc</span><span
            class="stat-val text-success-500" id="stat-val-acc">—</span></div>
        <div class="stat-box"><span class="stat-lbl">Status</span><span class="stat-val text-primary-500"
            id="stat-status">Idle</span></div>
        <div class="stat-box hidden" id="upload-box" style="flex:2"><span class="stat-lbl">Upload</span>
          <div class="h-1.5 bg-surface-200 rounded-full mt-1 overflow-hidden">
            <div
              class="h-full bg-gradient-to-r from-primary-500 to-success-400 rounded-full transition-all duration-300"
              id="upload-progress-bar" style="width:0%"></div>
          </div><span id="upload-pct" class="text-[.62rem] text-ink-100">0%</span>
        </div>
      </div>
      <div class="card p-3 overflow-hidden" style="grid-area:loss">
        <h3 class="section-title mb-1.5">Loss</h3><canvas id="loss-chart"></canvas>
      </div>
      <div class="card p-3 overflow-hidden" style="grid-area:acc">
        <h3 class="section-title mb-1.5" id="metric-chart-title">Accuracy (%)</h3><canvas id="acc-chart"></canvas>
      </div>
      <div class="card p-3 overflow-auto" style="grid-area:net">
        <h3 class="section-title mb-1.5">Active Layer</h3>
        <div class="overflow-auto h-[calc(100%-1.5rem)]"><svg id="net-svg-train" height="280" width="100"></svg></div>
      </div>
      <div class="card overflow-hidden flex flex-col" style="grid-area:log">
        <h3 class="section-title p-3 pb-0">Log</h3>
        <div id="log" class="flex-1 overflow-y-auto font-mono text-[.68rem] text-ink-200 p-2.5 flex flex-col gap-0.5">
        </div>
      </div>
    </div>
  </div>

  <script src="{% static 'js/builder.js' %}"></script>
  <script src="{% static 'js/train.js' %}"></script>
</body>

</html>